<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 åœ°ç‚¹ç®¡ç†å™¨</title>
    <link rel="stylesheet" href="https://unpkg.com" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 600px; width: 100%; z-index: 1; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-50">

<div id="app" class="max-w-5xl mx-auto p-4">
    <header class="flex justify-between items-center mb-6 bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
        <h1 class="text-xl font-black italic">MAPPER.2026</h1>
        <div class="flex gap-6">
            <button onclick="switchTab('map')" id="tab-map" class="pb-1 tab-active transition-all">åœ°å›¾è§†å›¾</button>
            <button onclick="switchTab('todo')" id="tab-todo" class="pb-1 text-gray-400 transition-all">
                å¾…åˆ†ç±» (<span id="todo-count">0</span>)
            </button>
        </div>
    </header>

    <!-- åœ°å›¾é¢æ¿ -->
    <div id="panel-map" class="block">
        <div id="map" class="rounded-3xl shadow-lg border-4 border-white"></div>
    </div>

    <!-- å¾…åŠé¢æ¿ -->
    <div id="panel-todo" class="hidden">
        <div id="todo-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- åŠ¨æ€å¡ç‰‡æ’å…¥ -->
        </div>
    </div>
</div>

<!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
<div id="modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-[1000] p-4">
    <div class="bg-white p-8 rounded-3xl w-full max-w-md shadow-2xl scale-95 transition-transform">
        <h3 class="text-2xl font-bold mb-2">å®Œå–„åœ°ç‚¹ä¿¡æ¯</h3>
        <p id="modal-title" class="text-gray-500 mb-6 text-sm"></p>
        <input type="hidden" id="edit-id">
        <div class="space-y-4">
            <div>
                <label class="text-xs font-bold text-gray-400 uppercase">ç±»åˆ«</label>
                <input id="edit-cat" type="text" placeholder="ä¾‹å¦‚ï¼šå’–å•¡å…, éœ²è¥ç‚¹" class="w-full border-2 border-gray-100 p-3 rounded-xl focus:border-blue-500 outline-none">
            </div>
            <div>
                <label class="text-xs font-bold text-gray-400 uppercase">Emoji æ ‡ç­¾</label>
                <input id="edit-emoji" type="text" placeholder="è¾“å…¥ Emoji æˆ– AI æè¿°" class="w-full border-2 border-gray-100 p-3 rounded-xl focus:border-blue-500 outline-none">
            </div>
            <div>
                <label class="text-xs font-bold text-gray-400 uppercase">è¯„åˆ†</label>
                <select id="edit-rate" class="w-full border-2 border-gray-100 p-3 rounded-xl outline-none">
                    <option value="5">â­â­â­â­â­ å¿…å»</option>
                    <option value="4">â­â­â­â­ æ¨è</option>
                    <option value="3">â­â­â­ è¿˜è¡Œ</option>
                </select>
            </div>
            <button onclick="saveToSheet()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition">ç¡®è®¤æ›´æ–°</button>
            <button onclick="closeModal()" class="w-full text-gray-400 py-2 hover:text-gray-600 transition">æš‚ä¸å¤„ç†</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com"></script>
<script>
    // é…ç½®ï¼šæ›¿æ¢ä¸ºä½ è‡ªå·±çš„ SheetDB API URL
    const API_URL = 'https://sheetdb.io'; 
    
    let map, markerGroup;
    let storeData = [];

    // 1. åˆå§‹åŒ–åœ°å›¾
    function initMap() {
        if (map) return;
        map = L.map('map', { zoomControl: false }).setView([31.23, 121.47], 11);
        L.tileLayer('https://{s}://{z}/{x}/{y}{r}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        markerGroup = L.layerGroup().addTo(map);
    }

    // 2. è·å–æ•°æ®
    async function fetchData() {
        try {
            const response = await fetch(API_URL);
            storeData = await response.json();
            renderUI();
        } catch (err) {
            console.error("æ•°æ®åŠ è½½å¤±è´¥:", err);
            alert("æ— æ³•è¯»å–è¡¨æ ¼æ•°æ®ï¼Œè¯·æ£€æŸ¥ API URLã€‚");
        }
    }

    // 3. æ¸²æŸ“ç•Œé¢
    function renderUI() {
        const todoList = document.getElementById('todo-list');
        const todoCount = document.getElementById('todo-count');
        todoList.innerHTML = '';
        markerGroup.clearLayers();

        let unidentifiedCount = 0;

        storeData.forEach(item => {
            // å¦‚æœ category ä¸ºç©ºï¼Œæ”¾å…¥å¾…åŠ
            if (!item.category || item.category === "") {
                unidentifiedCount++;
                todoList.innerHTML += `
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition cursor-pointer" onclick="openEditModal('${item.id}')">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-gray-800">${item.name}</h4>
                                <p class="text-xs text-gray-400 mt-1">${item.address || 'æš‚æ— åœ°å€'}</p>
                            </div>
                            <span class="bg-orange-50 text-orange-500 text-[10px] px-2 py-1 rounded-md font-bold italic">NEW</span>
                        </div>
                        <div class="mt-4 flex items-center text-blue-500 text-xs font-bold">
                            ç‚¹å‡»å®Œå–„ä¿¡æ¯ â†’
                        </div>
                    </div>`;
            } 
            // å¦‚æœæœ‰ category ä¸”æœ‰åæ ‡ï¼Œæ”¾å…¥åœ°å›¾
            else if (item.lat && item.lng) {
                const marker = L.marker([parseFloat(item.lat), parseFloat(item.lng)])
                    .bindPopup(`
                        <div class="text-center p-2">
                            <div class="text-2xl mb-1">${item.emoji || 'ğŸ“'}</div>
                            <div class="font-bold">${item.name}</div>
                            <div class="text-xs text-gray-400">${item.category}</div>
                            <div class="text-yellow-400 my-1">â˜… ${item.rating}</div>
                            <button onclick="openEditModal('${item.id}')" class="text-blue-500 text-[10px] border border-blue-500 px-2 py-1 rounded-full mt-2">é‡æ–°ç¼–è¾‘</button>
                        </div>
                    `);
                markerGroup.addLayer(marker);
            }
        });

        todoCount.innerText = unidentifiedCount;
    }

    // 4. æ‰“å¼€å¼¹çª—
    window.openEditModal = function(id) {
        const item = storeData.find(i => i.id == id);
        document.getElementById('edit-id').value = id;
        document.getElementById('modal-title').innerText = item.name;
        document.getElementById('edit-cat').value = item.category || '';
        document.getElementById('edit-emoji').value = item.emoji || 'ğŸ“';
        document.getElementById('edit-rate').value = item.rating || '5';
        document.getElementById('modal').classList.remove('hidden');
    }

    // 5. ä¿å­˜å¹¶å†™å› Google Sheets
    async function saveToSheet() {
        const id = document.getElementById('edit-id').value;
        const payload = {
            category: document.getElementById('edit-cat').value,
            emoji: document.getElementById('edit-emoji').value,
            rating: document.getElementById('edit-rate').value
        };

        // ä¹è§‚æ›´æ–° UI
        storeData = storeData.map(i => i.id == id ? {...i, ...payload} : i);
        renderUI();
        closeModal();

        // æ­£å¼å‘é€åˆ° API (SheetDB PATCH è¯­æ³•)
        try {
            const response = await fetch(`${API_URL}/id/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: payload })
            });
            if (response.ok) {
                console.log("è¡¨æ ¼æ›´æ–°æˆåŠŸ");
                if(payload.category) switchTab('map');
            }
        } catch (err) {
            alert("ä¿å­˜å¤±è´¥ï¼Œä½†æœ¬åœ°é¢„è§ˆå·²æ›´æ–°");
        }
    }

    // 6. Tab åˆ‡æ¢é€»è¾‘
    window.switchTab = function(tab) {
        const isMap = tab === 'map';
        document.getElementById('panel-map').style.display = isMap ? 'block' : 'none';
        document.getElementById('panel-todo').style.display = isMap ? 'none' : 'block';
        
        document.getElementById('tab-map').className = isMap ? 'pb-1 tab-active transition-all' : 'pb-1 text-gray-400 transition-all';
        document.getElementById('tab-todo').className = !isMap ? 'pb-1 tab-active transition-all' : 'pb-1 text-gray-400 transition-all';

        if (isMap) {
            setTimeout(() => map.invalidateSize(), 300); // å…³é”®ï¼šè§£å†³ Leaflet åœ¨éšè—å®¹å™¨ä¸­åˆå§‹åŒ–å¯¼è‡´çš„æ˜¾ç¤ºé”™è¯¯
        }
    }

    function closeModal() { document.getElementById('modal').classList.add('hidden'); }

    // åˆå§‹åŒ–åŠ è½½
    window.onload = () => {
        initMap();
        fetchData();
    };
</script>
</body>
</html>
