<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 45vh; width: 100%; }
        .page { display: none; height: calc(100vh - 65px); overflow-y: auto; padding-bottom: 80px; }
        .active { display: block; }
        .nav-active { color: #2563eb; font-weight: bold; border-top: 3px solid #2563eb; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Page 1: Map View -->
    <div id="p-map" class="page active">
        <div id="map"></div>
        <div class="p-4 bg-white border-b flex gap-2 sticky top-0 z-[1000] shadow-sm text-sm">
            <select id="f-cat" class="w-1/2 border p-2 rounded-lg" onchange="renderMap()">
                <option value="">All Categories</option>
            </select>
            <select id="f-rate" class="w-1/2 border p-2 rounded-lg" onchange="renderMap()">
                <option value="">All Ratings</option>
                <option value="5">5 Stars</option>
                <option value="4">4 Stars</option>
                <option value="3">3 Stars</option>
            </select>
        </div>
        <div id="map-list" class="p-4 space-y-3"></div>
    </div>

    <!-- Page 2: To-Rate -->
    <div id="p-rate" class="page">
        <div class="p-6">
            <h2 class="text-2xl font-black mb-1">To-Rate</h2>
            <div id="todo-list" class="mt-4 space-y-4"></div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 w-full bg-white border-t flex h-16 z-[2000]">
        <button onclick="showPage('p-map')" id="n-map" class="flex-1 flex flex-col items-center justify-center text-xs nav-active">
            <span>üó∫Ô∏è</span><span>Map</span>
        </button>
        <button onclick="showPage('p-rate')" id="n-rate" class="flex-1 flex flex-col items-center justify-center text-xs text-gray-400">
            <span>‚úçÔ∏è</span><span>To-Rate</span>
        </button>
    </nav>

    <!-- Modal Form -->
    <div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[3000] p-6">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 id="m-name" class="text-xl font-bold mb-4"></h3>
            <input id="m-cat" type="text" placeholder="Category" class="w-full border p-4 rounded-2xl mb-3 bg-gray-50 outline-none">
            <select id="m-rate" class="w-full border p-4 rounded-2xl mb-6 bg-gray-50">
                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
                <option value="3">‚≠ê‚≠ê‚≠ê</option>
            </select>
            <button onclick="generateSyncLink()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold">Open Form to Sync</button>
            <button onclick="closeModal()" class="w-full mt-2 text-gray-400 text-sm">Cancel</button>
        </div>
    </div>

    <script src="https://unpkg.com"></script>
    <script>
        // --- CONFIGURATION ---
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRNfKG3v-7ATgwAUWo-4P_ASP-_nEL0Azv1TWTRMoPwbIYhWNTsNMDaso7kF7t2jh27McbUaMu6hdQs/pubhtml'; 
        const FORM_BASE = 'https://forms.gle/AtiW79wLNiQVdgiRA'; 

        let db = [], map, markers = [], selectedItem = null;

        async function start() {
            map = L.map('map', { zoomControl: false }).setView([22.31, 114.17], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            await load();
        }

        async function load() {
            const res = await fetch(CSV_URL);
            const text = await res.text();
            const lines = text.split('\n').map(l => l.split(',').map(c => c.trim().replace(/^"|"$/g, '')));
            const headers = lines[0];
            
            db = lines.slice(1).map(row => {
                let o = {};
                headers.forEach((h, i) => o[h] = row[i]);
                return o;
            }).filter(i => i.Name);

            const cats = [...new Set(db.filter(i => i.Category).map(i => i.Category))];
            document.getElementById('f-cat').innerHTML = '<option value="">All Categories</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');

            renderMap();
            renderTodo();
        }

        function renderMap() {
            const cat = document.getElementById('f-cat').value;
            const rate = document.getElementById('f-rate').value;
            const list = document.getElementById('map-list');
            list.innerHTML = '';
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            db.filter(i => i.Category && (!cat || i.Category === cat) && (!rate || i.Rating === rate)).forEach(i => {
                const m = L.marker([i.Lat, i.Lng]).addTo(map).bindPopup(`<b>${i.Name}</b><br>${i.Category}`);
                markers.push(m);
                list.innerHTML += `<div class="bg-white p-4 rounded-xl border mb-2"><b>${i.Name}</b><br><small>${i.Category} ‚Ä¢ ${i.Rating}‚òÖ</small></div>`;
            });
        }

        function renderTodo() {
            const todo = db.filter(i => !i.Category);
            const list = document.getElementById('todo-list');
            list.innerHTML = todo.map(i => `
                <div class="bg-white p-4 rounded-xl border flex justify-between items-center" onclick="openModal('${i.ID}')">
                    <span>${i.Name}</span><span class="text-blue-500 font-bold">RATE</span>
                </div>`).join('');
        }

        function openModal(id) {
            selectedItem = db.find(x => x.ID == id);
            document.getElementById('m-name').innerText = selectedItem.Name;
            document.getElementById('modal').style.display = 'flex';
        }

        function generateSyncLink() {
            const cat = encodeURIComponent(document.getElementById('m-cat').value);
            const rate = document.getElementById('m-rate').value;
            // You replace the entry IDs here based on your form pre-filled link
            const syncUrl = FORM_BASE
                .replace('ID_VAL', selectedItem.ID)
                .replace('CAT_VAL', cat)
                .replace('RAT_VAL', rate);
            
            window.open(syncUrl, '_blank');
            closeModal();
            alert("Please SUBMIT the Google Form that just opened to update the sheet.");
        }

        function showPage(p) {
            document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
            document.getElementById(p).classList.add('active');
            document.getElementById('n-map').className = p === 'p-map' ? 'flex-1 flex flex-col items-center justify-center text-xs nav-active' : 'flex-1 flex flex-col items-center justify-center text-xs text-gray-400';
            document.getElementById('n-rate').className = p === 'p-rate' ? 'flex-1 flex flex-col items-center justify-center text-xs nav-active' : 'flex-1 flex flex-col items-center justify-center text-xs text-gray-400';
            if(p === 'p-map') setTimeout(() => map.invalidateSize(), 200);
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        window.onload = start;
    </script>
</body>
</html>
